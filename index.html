<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Meta tags for character set and viewport -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title of the webpage -->
    <title>The Enchanted Garden Story</title>
</head>

<body>
    <!-- Main content -->
    <h1>Generer historie!</h1>

    <!-- Input for user to provide a parameter for story generation -->
    <label for="about">About: </label>
    <input type="text" id="about">
    <!-- Button to initiate the story fetching process -->
    <button id="fetchButton">Fetch Story</button>
    <!-- Container for displaying the generated story -->
    <div id="result"></div>

    <script>
        // Variable to store the fetched story text
        let text = "";

        // DOM elements for interaction
        const fetchButton = document.getElementById('fetchButton');
        const aboutInput = document.getElementById('about');
        const resultDiv = document.getElementById('result');

        // Event listener for the fetch button
        fetchButton.addEventListener('click', () => {
            // Get the value from the "about" input
            const aboutValue = aboutInput.value;

            // Check if a value is provided
            if (!aboutValue) {
                resultDiv.innerHTML = 'Please enter a value for the "about" parameter.';
                return;
            }

            // Construct the URL for fetching the story based on the input
            const apiUrl = `http://localhost:8080/api/story?about=${aboutValue}`;

            // Fetch the story from the API
            fetch(apiUrl)
                .then(response => {
                    // Check if the network response is successful
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    // Store the fetched story text and generate the story
                    text = data;
                    generateStory();
                })
                .catch(error => {
                    // Handle errors during the fetch process
                    resultDiv.innerHTML = `Error: ${error.message}`;
                });
        });

        // Function to generate the story HTML based on the fetched text
        async function generateStory() {
            // Split the story text into parts based on specific patterns
            const parts = text.split(/\s*(?=\[[^\]]*\])\s*/);
            let html = '';

            let currentChapter = null;

            // Iterate through the parts to create HTML structure
            for (const part of parts) {
                const match = part.match(/\[([A-Z-]+):\s*(.*?)\]/);
                if (match) {
                    const key = match[1];
                    const value = match[2];

                    // Handle different types of story elements
                    if (key === 'CHAPTER-NUMBER') {
                        // Start a new chapter div
                        if (currentChapter) {
                            html += '</div>';
                        }
                        html += `<div class="chapter">`;

                        html += '<div style="display: flex; justify-content: space-evenly;">'  
                        html += '<div style="display: flex; flex-direction: column">'      
                        html += `<h1 style="text-align: center;">Kapitel ${value}</h1>`
                        currentChapter = value;
                    } else if (key === 'CHAPTER-TITLE') {
                        // Add chapter title
                        html += `<h1 style="text-align: center;">${value}</h1>`;
                    } else if (key === 'CHAPTER-TEXT') {
                        // Add chapter text
                        html += `<p style="font-size: 25px; font-weight: bold;">${value}</p>`;
                    } else if (key === 'CHAPTER-IMAGE-PROMPT') {
                        // Fetch and add an image based on the prompt
                        const imageUrl = await getImageUrl(value);
                        if (imageUrl) {
                            console.log('Image URL:', imageUrl);
                            html += '</div>'
                            html += `<img style="max-width: 50vw" src="${imageUrl}">`;
                            html += '</div>'
                        } else {
                            console.log('Failed to retrieve image URL.');
                        }
                    }
                }
            }

            // Close the last chapter div if it exists
            if (currentChapter) {
                html += '</div>';
            }

            // Display the generated story on the webpage
            resultDiv.innerHTML = html;
        }

        // Function to fetch an image URL based on a given prompt
        async function getImageUrl(prompt) {
            // URL for the image generation API
            const baseUrl = 'http://localhost:8080/api/image/generateimage';
            const fullUrl = `${baseUrl}?prompt=${encodeURIComponent(prompt)}`;

            try {
                // Fetch the image URL
                const response = await fetch(fullUrl);

                if (response.ok) {
                    // Return the fetched image URL
                    const imageUrl = await response.text();
                    return imageUrl;
                } else {
                    // Handle errors in the response
                    console.error(`Error: ${response.status} - ${response.statusText}`);
                    return null;
                }
            } catch (error) {
                // Handle fetch errors
                console.error('Error:', error.message);
                return null;
            }
        }
    </script>
</body>

</html>